  <!-- SCRIPT PRINCIPAL -->
  <script>
    // Banco de dados local (localStorage)
    const db = {
      loadMoradores: () => JSON.parse(localStorage.getItem("moradores")) || [],
      saveMoradores: (moradores) =>
        localStorage.setItem("moradores", JSON.stringify(moradores)),

      loadCorrespondencias: () =>
        JSON.parse(localStorage.getItem("correspondencias")) || [],
      saveCorrespondencias: (correspondencias) =>
        localStorage.setItem("correspondencias", JSON.stringify(correspondencias)),
    };

    // Variáveis globais
    let moradores = db.loadMoradores();
    let correspondencias = db.loadCorrespondencias();

    // Trocar seção
    function showSection(section) {
      document
        .querySelectorAll(".content")
        .forEach((el) => el.classList.add("hidden"));
      document
        .querySelectorAll(".nav-item")
        .forEach((el) => el.classList.remove("active"));

      document.getElementById(section + "-section").classList.remove("hidden");
      document
        .querySelector(`[onclick="showSection('${section}')"]`)
        .classList.add("active");
    }

    // Toast
    function showToast(message, type = "success") {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = "toast show " + (type === "error" ? "error" : "");
      setTimeout(() => {
        toast.className = "toast";
      }, 3000);
    }

    // Moradores
    function renderTabelaMoradores() {
      const tbody = document.getElementById("tabelaMoradores");
      tbody.innerHTML = "";

      if (moradores.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="3" class="no-data">Nenhum morador cadastrado</td></tr>';
        return;
      }

      moradores.forEach((m) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.nome}</td>
          <td>${m.apartamento}</td>
          <td>
            <a href="#" class="action-link" onclick="abrirEditarMorador(${m.id})"><i class="fas fa-edit"></i></a>
            <a href="#" class="action-link" onclick="excluirMorador(${m.id})"><i class="fas fa-trash"></i></a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updateCorrespondenceSelects() {
      const select = document.getElementById("moradorCorrespondencia");
      select.innerHTML = "";
      moradores.forEach((m) => {
        const option = document.createElement("option");
        option.value = m.id;
        option.textContent = `${m.nome} - Apto ${m.apartamento}`;
        select.appendChild(option);
      });
    }

    // Excluir morador (corrigido)
    function excluirMorador(id) {
      if (confirm("Tem certeza que deseja excluir este morador?")) {
        moradores = moradores.filter((m) => m.id !== Number(id));
        db.saveMoradores(moradores);
        renderTabelaMoradores();
        updateCorrespondenceSelects();
        showToast("Morador excluído com sucesso!", "success");
      }
    }

    // Editar morador
    function abrirEditarMorador(id) {
      const morador = moradores.find((m) => m.id === id);
      if (!morador) return;

      document.getElementById("editMoradorId").value = morador.id;
      document.getElementById("editNomeMorador").value = morador.nome;
      document.getElementById("editApartamentoMorador").value =
        morador.apartamento;

      abrirModal("modalEditarMorador");
    }

    // Correspondências
    function renderTabelaCorrespondenciasPendentes() {
      const tbody = document.getElementById("tabelaCorrespondenciasPendentes");
      tbody.innerHTML = "";

      const pendentes = correspondencias.filter((c) => !c.entregue);

      if (pendentes.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="5" class="no-data">Nenhuma correspondência pendente</td></tr>';
        return;
      }

      pendentes.forEach((c) => {
        const morador = moradores.find((m) => m.id === c.moradorId);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${morador ? morador.nome : "N/A"}</td>
          <td>${c.tipo}</td>
          <td>${c.descricao || "-"}</td>
          <td>${new Date(c.data).toLocaleDateString()}</td>
          <td>
            <a href="#" class="action-link" onclick="abrirEntrega(${c.id})"><i class="fas fa-check"></i></a>
            <a href="#" class="action-link" onclick="excluirCorrespondencia(${c.id})"><i class="fas fa-trash"></i></a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderTabelaCorrespondenciasEntregues() {
      const tbody = document.getElementById("tabelaCorrespondenciasEntregues");
      tbody.innerHTML = "";

      const entregues = correspondencias.filter((c) => c.entregue);

      if (entregues.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="6" class="no-data">Nenhuma correspondência entregue</td></tr>';
        return;
      }

      entregues.forEach((c) => {
        const morador = moradores.find((m) => m.id === c.moradorId);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${morador ? morador.nome : "N/A"}</td>
          <td>${c.tipo}</td>
          <td>${c.descricao || "-"}</td>
          <td>${new Date(c.data).toLocaleDateString()}</td>
          <td>${new Date(c.dataEntrega).toLocaleDateString()}</td>
          <td>
            <a href="#" class="action-link" onclick="excluirCorrespondencia(${c.id})"><i class="fas fa-trash"></i></a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Excluir correspondência (corrigido)
    function excluirCorrespondencia(id) {
      if (confirm("Tem certeza que deseja excluir esta correspondência?")) {
        correspondencias = correspondencias.filter((c) => c.id !== Number(id));
        db.saveCorrespondencias(correspondencias);
        renderTabelaCorrespondenciasPendentes();
        renderTabelaCorrespondenciasEntregues();
        updateDashboard();
        showToast("Correspondência excluída com sucesso!", "success");
      }
    }

    // Dashboard
    function updateDashboard() {
      document.getElementById("totalMoradores").textContent = moradores.length;
      document.getElementById("totalCorrespondencias").textContent =
        correspondencias.length;
      document.getElementById("pendentes").textContent = correspondencias.filter(
        (c) => !c.entregue
      ).length;
      document.getElementById("entregues").textContent = correspondencias.filter(
        (c) => c.entregue
      ).length;
    }

    // Modal
    function abrirModal(id) {
      document.getElementById(id).style.display = "block";
    }
    function fecharModal(id) {
      document.getElementById(id).style.display = "none";
    }

    // Eventos
    document
      .getElementById("formMorador")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const nome = document.getElementById("nomeMorador").value;
        const apartamento = document.getElementById("apartamentoMorador").value;

        moradores.push({ id: Date.now(), nome, apartamento });
        db.saveMoradores(moradores);
        renderTabelaMoradores();
        updateCorrespondenceSelects();
        updateDashboard();
        showToast("Morador adicionado com sucesso!");
        this.reset();
      });

    document
      .getElementById("formEditarMorador")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const id = Number(document.getElementById("editMoradorId").value);
        const nome = document.getElementById("editNomeMorador").value;
        const apartamento = document.getElementById(
          "editApartamentoMorador"
        ).value;

        const morador = moradores.find((m) => m.id === id);
        if (morador) {
          morador.nome = nome;
          morador.apartamento = apartamento;
          db.saveMoradores(moradores);
          renderTabelaMoradores();
          updateCorrespondenceSelects();
          updateDashboard();
          showToast("Morador atualizado com sucesso!");
          fecharModal("modalEditarMorador");
        }
      });

    document
      .getElementById("formCorrespondencia")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const moradorId = Number(
          document.getElementById("moradorCorrespondencia").value
        );
        const tipo = document.getElementById("tipoCorrespondencia").value;
        const descricao =
          document.getElementById("descricaoCorrespondencia").value;

        correspondencias.push({
          id: Date.now(),
          moradorId,
          tipo,
          descricao,
          data: new Date(),
          entregue: false,
        });

        db.saveCorrespondencias(correspondencias);
        renderTabelaCorrespondenciasPendentes();
        updateDashboard();
        showToast("Correspondência adicionada com sucesso!");
        this.reset();
      });

    document
      .getElementById("formEntrega")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const id = Number(document.getElementById("entregaId").value);
        const correspondencia = correspondencias.find((c) => c.id === id);
        if (correspondencia) {
          correspondencia.entregue = true;
          correspondencia.dataEntrega = new Date();
          db.saveCorrespondencias(correspondencias);
          renderTabelaCorrespondenciasPendentes();
          renderTabelaCorrespondenciasEntregues();
          updateDashboard();
          showToast("Entrega registrada com sucesso!");
          fecharModal("modalEntrega");
        }
      });

    function abrirEntrega(id) {
      const c = correspondencias.find((c) => c.id === id);
      if (!c) return;
      const morador = moradores.find((m) => m.id === c.moradorId);
      document.getElementById("entregaId").value = c.id;
      document.getElementById("entregaMorador").textContent = morador
        ? morador.nome
        : "N/A";
      abrirModal("modalEntrega");
    }

    // Inicialização
    renderTabelaMoradores();
    updateCorrespondenceSelects();
    renderTabelaCorrespondenciasPendentes();
    renderTabelaCorrespondenciasEntregues();
    updateDashboard();
  </script>
</body>
</html>
